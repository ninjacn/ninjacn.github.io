---
layout: post
status: publish
published: true
title: LVS-NAT故障详细分析
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: "HOWTO check step-by-step a Layer 4 LVS-NAT setup for problems\n\n\nQ.1 Can
  the real server ping client?\n\n\trs# ping -n client\n\nA.1 Yes => good\nA.2 No
  => bad\n\n\tSome settings for the director:\n\n\tLinux 2.2&#47;2.4:\n\tipchains
  -A forward -s RIP -j MASQ\n\n\tLinux 2.4:\n\tiptables -t nat -A POSTROUTING -s RIP
  -j MASQUERADE\n\nQ.2 Traceroute to client goes through LVS box and reaches the client?\n\n\ttraceroute
  -n -s RIP CLIENT_IP\n\nA.1 Yes => good\nA.2 No => bad\n\n\tsame ipchains command
  as in Q.1\n\n\tFor client and server on same physical media use these\n\tin the
  director:\n\n\techo 0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;all&#47;send_redirects\n\techo
  0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;<dev>&#47;send_redirects\n\n"
wordpress_id: 659
wordpress_url: http://ninjacn.com/?p=659
date: '2009-06-09 11:04:25 +0800'
date_gmt: '2009-06-09 03:04:25 +0800'
categories:
- Server
tags:
- lvs
- nat
- "排错"
- "故障"
comments: []
---
<p>HOWTO check step-by-step a Layer 4 LVS-NAT setup for problems</p>
<p>Q.1 Can the real server ping client?</p>
<p>	rs# ping -n client</p>
<p>A.1 Yes => good<br />
A.2 No => bad</p>
<p>	Some settings for the director:</p>
<p>	Linux 2.2&#47;2.4:<br />
	ipchains -A forward -s RIP -j MASQ</p>
<p>	Linux 2.4:<br />
	iptables -t nat -A POSTROUTING -s RIP -j MASQUERADE</p>
<p>Q.2 Traceroute to client goes through LVS box and reaches the client?</p>
<p>	traceroute -n -s RIP CLIENT_IP</p>
<p>A.1 Yes => good<br />
A.2 No => bad</p>
<p>	same ipchains command as in Q.1</p>
<p>	For client and server on same physical media use these<br />
	in the director:</p>
<p>	echo 0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;all&#47;send_redirects<br />
	echo 0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;<dev>&#47;send_redirects</p>
<p><a id="more"></a><a id="more-659"></a><br />
Q.3 Is the traffic forwarded from the LVS box, in both directions?</p>
<p>	For all interfaces on director:<br />
	tcpdump -ln host CLIENT_IP</p>
<p>	The right sequence, i.e. the IP addresses and ports on each<br />
	step (the reversed for the in->out direction are not shown):</p>
<p>	CLIENT<br />
	   | CIP:CPORT -> VIP:VPORT<br />
	   |		||<br />
	   |		\&#47;<br />
 out	   | CIP:CPORT -> VIP:VPORT<br />
 ||	LVS box<br />
 \&#47;	   | CIP:CPORT -> RIP:RPORT<br />
 in	   |		||<br />
	   |		\&#47;<br />
	   | CIP:CPORT -> RIP:RPORT<br />
	   +<br />
	REAL SERVER</p>
<p>A.1 Yes, in both directions => good (for Layer 4, probably not for L7)<br />
A.2 The packets from the real server are dropped => bad:</p>
<p>	- rp_filter protection on the incoming interface, probably<br />
	hit from local client<br />
	- firewall rules drop the replies</p>
<p>A.3 The packets from the real servers leave the director unchanged</p>
<p>	- missing -j MASQ ipchains rule in the LVS box</p>
<p>	For client and server on same physical media:</p>
<p>	The packets simply does not reach the director. The real<br />
	server is ICMP redirected to the client. In director:</p>
<p>	echo 0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;all&#47;send_redirects<br />
	echo 0 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;conf&#47;<dev>&#47;send_redirects</p>
<p>A.4 All packets from the client are dropped</p>
<p>	- the requests are received on wrong interface with rp_filter<br />
	protection<br />
	- firewall rules drop the requests</p>
<p>A.5 The client connections are refused or are served from service<br />
in the LVS box</p>
<p>	- client and LVS are on same host => not valid<br />
	- the packets are not marked from the firewall and don't hit<br />
	firewall mark based virtual service</p>
<p>Q.4 Is the traffic replied from the real server?</p>
<p>	For the outgoing interface on real server:</p>
<p>	tcpdump -ln host CLIENT_IP</p>
<p>A.1 Yes, SYN+ACK => good<br />
A.2 TCP RST => bad, No listening real service<br />
A.3 ICMP message => bad, Blocked from Firewall&#47;No listening service<br />
A.4 The same request packet leaves the real server => missing accept<br />
	rules or RIP is not defined<br />
A.5 No reply => real server problem:</p>
<p>	- the rp_filter protection drops the packets<br />
	- the firewall drops the request packets<br />
	- the firewall drops the replies</p>
<p>A.6 Replies goes through another device or don't go to the LVS<br />
box =? bad</p>
<p>	- the route to the client is direct and so don't pass the LVS<br />
	box, for example:</p>
<p>		- client on the LAN<br />
		- client and real server on same host</p>
<p>	- wrong route to the LVS box is used => use another</p>
<p>	Check the route:</p>
<p>	rs# ip route get CLIENT_IP from RIP</p>
<p>The result: start the following tests</p>
<p>rs# tcpdump -ln host CIP<br />
rs# traceroute -n -s RIP CIP<br />
lvs# tcpdump -ln host CIP<br />
client# tcpdump -ln host CIP</p>
<p>For more deep problems use tcpdump -len, i.e. sometimes the link layer<br />
addresses help a bit.</p>
<p>For FTP:</p>
<p>	LVS-NAT in Linux 2.2 requires:</p>
<p>	- modprobe ip_masq_ftp (before 2.2.19)<br />
	- modprobe ip_masq_ftp in_ports=21 (2.2.19+)</p>
<p>	LVS-NAT in Linux 2.4 requires:</p>
<p>	- ip_vs_ftp</p>
<p>	LVS-DR&#47;TUN require persistent flag</p>
<p>	FTP reports with debug mode enabled are useful:</p>
<p>	# ftp<br />
	ftp> debug<br />
	ftp> open my.virtual.ftp.service<br />
	ftp> ...<br />
	ftp> dir<br />
	ftp> passive<br />
	ftp> dir</p>
<p>	There are reports that sometimes the status strings reported<br />
	from the FTP real servers are not matched with the string<br />
	constants encoded in the kernel FTP support. For example,<br />
	Linux 2.2.19 matches<br />
	"227 Entering Passive Mode (xxx,xxx,xxx,xxx,ppp,ppp)"</p>
<p>Julian Anastasov</p>
