---
layout: post
status: publish
published: true
title: vsftp虚拟用户配置
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: "配置如下：\r\n<code>\r\nanonymous_enable=NO\r\nlocal_enable=YES\r\nwrite_enable=YES\r\nanon_upload_enable=YES\r\nanon_mkdir_write_enable=YES\r\nanon_other_write_enable=YES\r\nchroot_local_user=YES\r\nguest_enable=YES\r\nguest_username=virtual\r\nlisten=YES\r\nlisten_port=21\r\n\r\npasv_min_port=30000\r\npasv_max_port=30999\r\nxferlog_enable=YES\r\nxferlog_file=&#47;var&#47;log&#47;vsftpd.log\r\nanon_world_readable_only=NO\r\n<&#47;code>\r\n\r\n[root@test
  etc]# cat &#47;etc&#47;pam.d&#47;ftp \r\nauth required &#47;lib64&#47;security&#47;pam_userdb.so
  db=&#47;etc&#47;vsftpd_login\r\naccount required &#47;lib64&#47;security&#47;pam_userdb.so
  db=&#47;etc&#47;vsftpd_login"
wordpress_id: 755
wordpress_url: http://ninjacn.com/?p=755
date: '2009-10-27 23:53:15 +0800'
date_gmt: '2009-10-27 15:53:15 +0800'
categories:
- Server
tags:
- vsftp
comments: []
---
<p>配置如下：<br />
<code><br />
anonymous_enable=NO<br />
local_enable=YES<br />
write_enable=YES<br />
anon_upload_enable=YES<br />
anon_mkdir_write_enable=YES<br />
anon_other_write_enable=YES<br />
chroot_local_user=YES<br />
guest_enable=YES<br />
guest_username=virtual<br />
listen=YES<br />
listen_port=21</p>
<p>pasv_min_port=30000<br />
pasv_max_port=30999<br />
xferlog_enable=YES<br />
xferlog_file=&#47;var&#47;log&#47;vsftpd.log<br />
anon_world_readable_only=NO<br />
<&#47;code></p>
<p>[root@test etc]# cat &#47;etc&#47;pam.d&#47;ftp<br />
auth required &#47;lib64&#47;security&#47;pam_userdb.so db=&#47;etc&#47;vsftpd_login<br />
account required &#47;lib64&#47;security&#47;pam_userdb.so db=&#47;etc&#47;vsftpd_login<a id="more"></a><a id="more-755"></a></p>
<p>启动成功后浏览目录，下载都正常，唯独上传文件不行。<br />
提示：553 Could not create file<br />
网上大多文章只说关闭SELINUX就可以解决，但我的问题依旧。最后查到，在虚拟用户virtual的家目录新建一个0777权限的目录，上传至这个文件夹下面一切正常，也不知道什么原因。<br />
参考信息如下：<br />
Following are the common errors you will encounter when setting anonymous vsftp-2.0.5</p>
<p>4) error: need to access to a designated dir for anonymous ftp<br />
Set following:<br />
anon_root=&#47;var&#47;www&#47;html&#47;docs</p>
<p>5) error: 500 OOPS: vsftpd: refusing to run with writable anonymous root<br />
sympton:<br />
[root@localhost ~]# ftp 70.234.256.239<br />
Connected to 70.234.256.239.<br />
220 Welcome to My FTP service.<br />
530 Please login with USER and PASS.<br />
530 Please login with USER and PASS.<br />
KERBEROS_V4 rejected as an authentication type<br />
Name (70.234.256.239:root): anonymous<br />
331 Please specify the password.<br />
Password:<br />
500 OOPS: vsftpd: refusing to run with writable anonymous root<br />
Login failed.</p>
<p>Reason:<br />
Change attribute of ftp directory from<br />
drwxrwxrwx 3 root root 4096 Jun 13 18:42 docs<br />
To<br />
dr-xr-xr-x 3 root root 4096 Jun 13 18:42 docs</p>
<p>6) error: 553 Could not create file.<br />
Sympton:<br />
ftp> put t.txt<br />
local: t.txt remote: t.txt<br />
227 Entering Passive Mode (192,168,1,103,245,163)<br />
553 Could not create file.</p>
<p>Reason:<br />
You need to create a sub dir under ftp dir with 0777 attribute as</p>
<p>drwxrwxrwx 2 ftp ftp 4096 Jun 15 00:40 pub</p>
<p>7) error: anonymously uploaded file has attribute (mask) 0600,<br />
these files could not be downloaded</p>
<p>rw------- 3 root root 4096 Jun 13 18:42 t.txt</p>
<p>Reason:<br />
anon_umask=0133 does not take effect in the code.<br />
In the file "postlogin.c", make following changes:</p>
<p>&#47;&#47;vsf_sysutil_fchmod(new_file_fd, 0600); &#47;&#47;jwei removes<br />
vsf_sysutil_fchmod(new_file_fd, 0777^tunable_anon_umask); &#47;&#47;jwei adds</p>
<p>recompile and cp to &#47;usr&#47;local&#47;sbin&#47;vsftpd</p>
<p>8) error: 425 Security: Bad IP connecting.<br />
ftp>ls<br />
425 Security: Bad IP connecting.</p>
<p>Reason:<br />
Set following:<br />
pasv_promiscuous=YES</p>
