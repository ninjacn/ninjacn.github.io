---
layout: post
status: publish
published: true
title: keepalived简单测试-高可用性
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
wordpress_id: 858
wordpress_url: http://ninjacn.com/?p=858
date: '2010-01-11 17:05:30 +0800'
date_gmt: '2010-01-11 09:05:30 +0800'
categories:
- Server
tags:
- keepalived
- "高可用性"
comments: []
---
<p>系统：centos 5.3	keepalived:1.1.19<br />
VIP：IP：192.168.1.18<br />
MASTER:IP:192.168.1.10<br />
BACKUP:IP:192.168.1.20</p>
<p>MASTER(node1)安装及配置:<br />
[root@node1 ~]# wget http:&#47;&#47;www.keepalived.org&#47;software&#47;keepalived-1.1.19.tar.gz<br />
[root@node1 ~]# tar xzvf keepalived-1.1.19.tar.gz<br />
[root@node1 ~]# cd keepalived-1.1.19</p>
<p>[root@node1 keepalived-1.1.19]#.&#47;configure --prefix=&#47; --mandir=&#47;usr&#47;share&#47;man --disable-lvs-syncd --disable-lvs<br />
Keepalived configuration<br />
------------------------<br />
Keepalived version       : 1.1.19<br />
Compiler                 : gcc<br />
Compiler flags           : -g -O2<br />
Extra Lib                : -lpopt -lssl -lcrypto<br />
Use IPVS Framework       : No<br />
IPVS sync daemon support : No<br />
Use VRRP Framework       : Yes<br />
Use Debug flags          : No<br />
[root@node1 keepalived-1.1.19]# make && make install</p>
<p>[cc lang="apache"]! Configuration File for keepalived</p>
<p>global_defs {<br />
   notification_email {<br />
     sysadmin@firewall.loc<br />
   }<br />
   notification_email_from Alexandre.Cassen@firewall.loc<br />
   smtp_server 127.0.0.1<br />
   smtp_connect_timeout 30<br />
   router_id LVS_DEVEL<br />
}</p>
<p>vrrp_instance VI_1 {<br />
    state MASTER<br />
    interface eth0<br />
    virtual_router_id 51<br />
    priority 100(backup优先级高于master,仅测试)<br />
    advert_int 1<br />
    authentication {<br />
        auth_type PASS<br />
        auth_pass 1111<br />
    }<br />
    virtual_ipaddress {<br />
        192.168.1.18<br />
    }<br />
}[&#47;cc]查看日志：<br />
[root@node1 keepalived-1.1.19]# tail &#47;var&#47;log&#47;messages -n 100<br />
Jan 10 04:02:03 node1 syslogd 1.4.1: restart.<br />
Jan 11 16:35:58 node1 Keepalived: Starting Keepalived v1.1.19 (01&#47;11,2010)<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Registering Kernel netlink reflector<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Registering Kernel netlink command channel<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Registering gratutious ARP shared channel<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Opening file '&#47;etc&#47;keepalived&#47;keepalived.conf'.<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Configuration is using : 38644 Bytes<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: Using LinkWatch kernel netlink reflector...<br />
Jan 11 16:35:58 node1 Keepalived_vrrp: VRRP sockpool: [ifindex(2), proto(112), fd(9,10)]<br />
Jan 11 16:35:58 node1 Keepalived: Starting VRRP child process, pid=8664<br />
Jan 11 16:35:59 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Transition to MASTER STATE<br />
Jan 11 16:36:00 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Entering MASTER STATE<br />
Jan 11 16:36:00 node1 Keepalived_vrrp: VRRP_Instance(VI_1) setting protocol VIPs.<br />
Jan 11 16:36:00 node1 avahi-daemon[2360]: Registering new address record for 192.168.1.18 on eth0.<br />
Jan 11 16:36:00 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.1.18<br />
Jan 11 16:36:05 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.1.18<br />
Jan 11 16:36:08 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Received higher prio advert<br />
Jan 11 16:36:08 node1 Keepalived_vrrp: VRRP_Instance(VI_1) Entering BACKUP STATE<br />
Jan 11 16:36:08 node1 Keepalived_vrrp: VRRP_Instance(VI_1) removing protocol VIPs.<br />
Jan 11 16:36:08 node1 avahi-daemon[2360]: Withdrawing address record for 192.168.1.18 on eth0.</p>
<p>日志显示刚启动获取到IP，后释放返回至BACKUP状态</p>
<p>BACKUP(node1)安装及配置:<br />
安装过程跟MASTER一样，过程略。。。<br />
配置如下：<br />
[cc lang="apache"]! Configuration File for keepalived</p>
<p>global_defs {<br />
   notification_email {<br />
     sysadmin@firewall.loc<br />
   }<br />
   notification_email_from Alexandre.Cassen@firewall.loc<br />
   smtp_server 127.0.0.1<br />
   smtp_connect_timeout 30<br />
   router_id LVS_DEVEL<br />
}</p>
<p>vrrp_instance VI_1 {<br />
    state BACKUP<br />
#    state MASTER<br />
    interface eth0<br />
    virtual_router_id 51<br />
    priority 150 (backup优先级高于master,仅测试)<br />
    advert_int 1<br />
    authentication {<br />
        auth_type PASS<br />
        auth_pass 1111<br />
    }<br />
    virtual_ipaddress {<br />
        192.168.1.18<br />
    }<br />
}[&#47;cc]<br />
查看日志：<br />
[root@node1_0 ~]# tail &#47;var&#47;log&#47;messages -n 100<br />
Jan 10 04:02:05 node1_0 syslogd 1.4.1: restart.<br />
Jan 11 16:35:32 node1_0 Keepalived: Starting Keepalived v1.1.19 (01&#47;11,2010)<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Registering Kernel netlink reflector<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Registering Kernel netlink command channel<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Registering gratutious ARP shared channel<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Opening file '&#47;etc&#47;keepalived&#47;keepalived.conf'.<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Configuration is using : 38482 Bytes<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: Using LinkWatch kernel netlink reflector...<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) Entering BACKUP STATE<br />
Jan 11 16:35:32 node1_0 Keepalived_vrrp: VRRP sockpool: [ifindex(2), proto(112), fd(9,10)]<br />
Jan 11 16:35:32 node1_0 Keepalived: Starting VRRP child process, pid=11567<br />
Jan 11 16:35:33 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) forcing a new MASTER election<br />
Jan 11 16:35:34 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) Transition to MASTER STATE<br />
Jan 11 16:35:35 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) Entering MASTER STATE<br />
Jan 11 16:35:35 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) setting protocol VIPs.<br />
Jan 11 16:35:35 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.1.18<br />
Jan 11 16:35:35 node1_0 avahi-daemon[2528]: Registering new address record for 192.168.1.18 on eth0.<br />
Jan 11 16:35:40 node1_0 Keepalived_vrrp: VRRP_Instance(VI_1) Sending gratuitous ARPs on eth0 for 192.168.1.18</p>
<p>日志显示由BACKUP状态转变为MASTER状态。</p>
<p>测试apache:<br />
正常情况下，网页在BACKUP机192.168.1.20<br &#47;><br />
<a href="http:&#47;&#47;ninjacn.com&#47;wp-content&#47;uploads&#47;2010&#47;01&#47;11.png"><img src="http:&#47;&#47;ninjacn.com&#47;wp-content&#47;uploads&#47;2010&#47;01&#47;11.png" alt="1" title="1" width="531" height="189" class="alignnone size-full wp-image-859" &#47;><&#47;a></p>
<p>停止keepalived服务进行测试<br />
[cc lang="apache"][root@node1_0 ~]# &#47;etc&#47;init.d&#47;keepalived stop<br />
Stopping keepalived:                                       [  OK  ][&#47;cc]</p>
<p>在BACKUP机上停止keepalived服务，VIP将被MASTER获取<br />
网页在MASTER机192.168.1.10<br />
<a href="http:&#47;&#47;ninjacn.com&#47;wp-content&#47;uploads&#47;2010&#47;01&#47;2.png"><img src="http:&#47;&#47;ninjacn.com&#47;wp-content&#47;uploads&#47;2010&#47;01&#47;2.png" alt="2" title="2" width="530" height="195" class="alignnone size-full wp-image-860" &#47;><&#47;a></p>
