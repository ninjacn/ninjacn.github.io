---
layout: post
status: publish
published: true
title: linux下logrotate的配置
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: "对于Linux 的系统安全来说，日志文件是极其重要的工具。系统管理员可以使用logrotate 程序用来管理系统中的最新的事件，对于Linux
  的系统安全来说，日志文件是极其重要的工具。系统管理员可以使用logrotate 程序用来管理系统中的最新的事件。logrotate 还可以用来备份日志文件，本篇将通过以下几部分来介绍
  \r\n日志文件的管理：\r\n1、logrotate 配置\r\n2、缺省配置 logrotate\r\n3、使用include 选项读取其他配置文件\r\n4、使用include
  选项覆盖缺省配置\r\n5、为指定的文件配置转储参数"
wordpress_id: 801
wordpress_url: http://ninjacn.com/?p=801
date: '2009-12-08 11:50:48 +0800'
date_gmt: '2009-12-08 03:50:48 +0800'
categories:
- System
tags:
- linux
- logrotate
comments: []
---
<p>对于Linux 的系统安全来说，日志文件是极其重要的工具。系统管理员可以使用logrotate 程序用来管理系统中的最新的事件，对于Linux 的系统安全来说，日志文件是极其重要的工具。系统管理员可以使用logrotate 程序用来管理系统中的最新的事件。logrotate 还可以用来备份日志文件，本篇将通过以下几部分来介绍<br />
日志文件的管理：<br />
1、logrotate 配置<br />
2、缺省配置 logrotate<br />
3、使用include 选项读取其他配置文件<br />
4、使用include 选项覆盖缺省配置<br />
5、为指定的文件配置转储参数<a id="more"></a><a id="more-801"></a><br />
一、logrotate 配置</p>
<p>logrotate 程序是一个日志文件管理工具。用来把旧的日志文件删除，并创建新的日志文件，我们把它叫做&ldquo;转储&rdquo;。我们可以根据日志文件的大小，也可以根据其天数来转储，这个过程一般通过 cron 程序来执行。<br />
logrotate 程序还可以用于压缩日志文件，以及发送日志到指定的E-mail 。</p>
<p>logrotate 的配置文件是 &#47;etc&#47;logrotate.conf。主要参数如下表：</p>
<p>参数 功能<br />
compress 通过gzip 压缩转储以后的日志<br />
nocompress 不需要压缩时，用这个参数<br />
copytruncate 用于还在打开中的日志文件，把当前日志备份并截断<br />
nocopytruncate 备份日志文件但是不截断<br />
create mode owner group 转储文件，使用指定的文件模式创建新的日志文件<br />
nocreate 不建立新的日志文件<br />
delaycompress 和 compress 一起使用时，转储的日志文件到下一次转储时才压缩<br />
nodelaycompress 覆盖 delaycompress 选项，转储同时压缩。<br />
errors address 专储时的错误信息发送到指定的Email 地址<br />
ifempty 即使是空文件也转储，这个是 logrotate 的缺省选项。<br />
notifempty 如果是空文件的话，不转储<br />
mail address 把转储的日志文件发送到指定的E-mail 地址<br />
nomail 转储时不发送日志文件<br />
olddir directory 转储后的日志文件放入指定的目录，必须和当前日志文件在同一个文件系统<br />
noolddir 转储后的日志文件和当前日志文件放在同一个目录下<br />
prerotate&#47;endscript 在转储以前需要执行的命令可以放入这个对，这两个关键字必须单独成行<br />
postrotate&#47;endscript 在转储以后需要执行的命令可以放入这个对，这两个关键字必须单独成行<br />
daily 指定转储周期为每天<br />
weekly 指定转储周期为每周<br />
monthly 指定转储周期为每月<br />
rotate count 指定日志文件删除之前转储的次数，0 指没有备份，5 指保留5 个备份<br />
tabootext [+] list 让logrotate 不转储指定扩展名的文件，缺省的扩展名是：.rpm-orig, .rpmsave, v, 和 ~<br />
size size 当日志文件到达指定的大小时才转储，Size 可以指定 bytes (缺省)以及KB (sizek)或者MB (sizem).<br />
二、缺省配置 logrotate</p>
<p>logrotate 缺省的配置募?&#47;etc&#47;logrotate.conf。<br />
Red Hat Linux 缺省安装的文件内容是：<br />
[cc lang="apache"]<br />
# see "man logrotate" for details<br />
# rotate log files weekly<br />
weekly</p>
<p># keep 4 weeks worth of backlogs<br />
rotate 4</p>
<p># send errors to root<br />
errors root<br />
# create new (empty) log files after rotating old ones<br />
create</p>
<p># uncomment this if you want your log files compressed<br />
#compress<br />
1<br />
# RPM packages drop log rotation information into this directory<br />
include &#47;etc&#47;logrotate.d</p>
<p># no packages own lastlog or wtmp --we'll rotate them here<br />
&#47;var&#47;log&#47;wtmp {<br />
monthly<br />
create 0664 root utmp<br />
rotate 1<br />
}</p>
<p>&#47;var&#47;log&#47;lastlog {<br />
monthly<br />
rotate 1<br />
}</p>
<p># system-specific logs may be configured here[&#47;cc]<br />
缺省的配置一般放在logrotate.conf 文件的最开始处，影响整个系统。在本例中就是前面12行。</p>
<p>第三行weekly 指定所有的日志文件每周转储一次。<br />
第五行 rotate 4 指定转储文件的保留 4份。<br />
第七行 errors root 指定错误信息发送给root。<br />
第九行create 指定 logrotate 自动建立新的日志文件，新的日志文件具有和<br />
原来的文件一样的权限。<br />
第11行 #compress 指定不压缩转储文件，如果需要压缩，去掉注释就可以了。</p>
<p>三、使用include 选项读取其他配置文件<br />
include 选项允许系统管理员把分散到几个文件的转储信息，集中到一个<br />
主要的配置文件。当 logrotate 从logrotate.conf 读到include 选项时，会从指定文件读入配置信息，就好像他们已经在&#47;etc&#47;logrotate.conf 中一样。</p>
<p>第13行 include &#47;etc&#47;logrotate.d 告诉 logrotate 读入存放在&#47;etc&#47;logrotate.d 目录中的日志转储参数，当系统中安装了RPM 软件包时，使用include 选项十分有用。RPM 软件包的日志转储参数一般存放在&#47;etc&#47;logrotate.d 目录。</p>
<p>include 选项十分重要，一些应用把日志转储参数存放在 &#47;etc&#47;logrotate.d 。</p>
<p>典型的应用有：apache, linuxconf, samba, cron 以及syslog。</p>
<p>这样，系统管理员只要管理一个 &#47;etc&#47;logrotate.conf 文件就可以了。 </p>
<p>四、使用include 选项覆盖缺省配置</p>
<p>当 &#47;etc&#47;logrotate.conf 读入文件时，include 指定的文件中的转储参数将覆盖缺省的参数，如下例：</p>
<p># linuxconf 的参数<br />
[cc lang="apache"]&#47;var&#47;log&#47;htmlaccess.log<br />
{ errors jim<br />
notifempty<br />
nocompress<br />
weekly<br />
prerotate<br />
&#47;usr&#47;bin&#47;chattr -a &#47;var&#47;log&#47;htmlaccess.log<br />
endscript<br />
postrotate<br />
&#47;usr&#47;bin&#47;chattr +a &#47;var&#47;log&#47;htmlaccess.log<br />
endscript<br />
}<br />
&#47;var&#47;log&#47;netconf.log<br />
{ nocompress<br />
monthly<br />
}[&#47;cc]</p>
<p>在这个例子中，当 &#47;etc&#47;logrotate.d&#47;linuxconf 文件被读入时，下面的参数将覆盖&#47;etc&#47;logrotate.conf中缺省的参数。</p>
<p>Notifempty<br />
errors jim</p>
<p>五、为指定的文件配置转储参数<br />
经常需要为指定文件配置参数，一个常见的例子就是每月转储&#47;var&#47;log&#47;wtmp。为特定文件而使用的参数格式是：</p>
<p># 注释<br />
[cc lang="apache"]&#47;full&#47;path&#47;to&#47;file<br />
{<br />
option(s)<br />
}[&#47;cc]下面的例子就是每月转储 &#47;var&#47;log&#47;wtmp 一次：<br />
[cc lang="apache"]#Use logrotate to rotate wtmp<br />
&#47;var&#47;log&#47;wtmp<br />
{<br />
monthly<br />
rotate 1<br />
}[&#47;cc]</p>
<p>六、其他需要注意的问题</p>
<p>1、尽管花括号的开头可以和其他文本放在同一行上，但是结尾的花括号必须单独成行。</p>
<p>2、使用 prerotate 和 postrotate 选项<br />
下面的例子是典型的脚本 &#47;etc&#47;logrotate.d&#47;syslog，这个脚本只是对<br />
&#47;var&#47;log&#47;messages 有效。<br />
[cc lang="apache"]<br />
&#47;var&#47;log&#47;messages<br />
{<br />
prerotate<br />
&#47;usr&#47;bin&#47;chattr -a &#47;var&#47;log&#47;messages<br />
endscript<br />
postrotate<br />
&#47;usr&#47;bin&#47;kill -HUP syslogd<br />
&#47;usr&#47;bin&#47;chattr +a &#47;var&#47;log&#47;messages<br />
endscript<br />
}[&#47;cc]</p>
<p>第一行指定脚本对 &#47;var&#47;log messages 有效<br />
花括号外的&#47;var&#47;log messages </p>
<p> prerotate 命令指定转储以前的动作&#47;usr&#47;bin&#47;chattr -a 去掉&#47;var&#47;log&#47;messages文件的&ldquo;只追加&rdquo;属性 endscript 结束 prerotate 部分的脚本postrotate 指定转储后的动作</p>
<p>[cc lang="bash"]&#47;usr&#47;bin&#47;killall -HUP syslogd [&#47;cc]</p>
<p>用来重新初始化系统日志守护程序 syslogd</p>
<p>[cc lang="bash"]&#47;usr&#47;bin&#47;chattr +a &#47;var&#47;log&#47;messages [&#47;cc]</p>
<p>重新为 &#47;var&#47;log&#47;messages 文件指定&ldquo;只追加&rdquo;属性，这样防治程序员或用户覆盖此文件。</p>
<p>最后的 endscript 用于结束 postrotate 部分的脚本</p>
<p>3、logrotate 的运行分为三步：</p>
<p>判断系统的日志文件，建立转储计划以及参数，通过cron daemon 运行下面的代码是 Red Hat Linux 缺省的crontab 来每天运行logrotate。</p>
<p>[cc lang="bash"]#&#47;etc&#47;cron.daily&#47;logrotate<br />
#! &#47;bin&#47;sh</p>
<p>&#47;usr&#47;sbin&#47;logrotate &#47;etc&#47;logrotate.conf[&#47;cc]</p>
<p>4、&#47;var&#47;log&#47;messages 不能产生的原因：<br />
这种情况很少见，但是如果你把&#47;etc&#47;services 中的 514&#47;UDP 端口关掉的话，这个文件就不能产生了。</p>
<p>小结：本文通过对Red Hat 系统上典型的logrotate 配置例子的介绍，详细说明了logrotate 程序的应用方法。希望对所有Linux 系统管理员有所帮助。管理好，分析好日志文件是系统安全的第一步，在以后的文章里FreeLAMP还会介绍另外一个检查日志的好东东 logcheck。</p>
<p>本文来自CSDN博客，转载请标明出处：http:&#47;&#47;blog.csdn.net&#47;cjwid&#47;archive&#47;2007&#47;07&#47;14&#47;1690101.aspx</p>
