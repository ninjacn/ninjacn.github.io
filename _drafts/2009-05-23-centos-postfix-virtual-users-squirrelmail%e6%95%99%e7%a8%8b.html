---
layout: post
status: publish
published: true
title: CentOS + Postfix + virtual users + Squirrelmail教程
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: |
  原文:http:&#47;&#47;www.wains.be&#47;index.php&#47;20 ... lisateurs-virtuels&#47;
  I manage a network of around 30 computers (25 active clients win&#47;linux, 7 servers win&#47;linux)

  I have implemented an email solution based on CentOS and Postfix to easier mail exchange internally and avoid slowness of our ex host.

  This article is not really meant to be an howto but an overview of our current configuration.
  It may give you ideas or help figuring out some parameters. Some stuff may be missing as well..

  If you have any questions, leave a note..

  Last update : June 22, 2005

  SpamAssassin : http:&#47;&#47;spamassassin.apache.org
  Postfix : http:&#47;&#47;www.postfix.org
  vmail : http:&#47;&#47;www.probsd.net&#47;vmail&#47;
  SquirrelMail : http:&#47;&#47;www.squirrelmail.org&#47;
wordpress_id: 493
wordpress_url: http://ninjacn.com/?p=493
date: '2009-05-23 20:30:39 +0800'
date_gmt: '2009-05-23 12:30:39 +0800'
categories:
- Server
tags:
- centos
- postfix
- squirrelmail
comments: []
---
<p>原文:http:&#47;&#47;www.wains.be&#47;index.php&#47;20 ... lisateurs-virtuels&#47;<br />
I manage a network of around 30 computers (25 active clients win&#47;linux, 7 servers win&#47;linux)</p>
<p>I have implemented an email solution based on CentOS and Postfix to easier mail exchange internally and avoid slowness of our ex host.</p>
<p>This article is not really meant to be an howto but an overview of our current configuration.<br />
It may give you ideas or help figuring out some parameters. Some stuff may be missing as well..</p>
<p>If you have any questions, leave a note..</p>
<p>Last update : June 22, 2005</p>
<p>SpamAssassin : http:&#47;&#47;spamassassin.apache.org<br />
Postfix : http:&#47;&#47;www.postfix.org<br />
vmail : http:&#47;&#47;www.probsd.net&#47;vmail&#47;<br />
SquirrelMail : http:&#47;&#47;www.squirrelmail.org&#47;<br />
<a id="more"></a><a id="more-493"></a><br />
Postfix 2.0.16 recompiled with MySQL support : http:&#47;&#47;www.wains.be&#47;pub&#47;postfix- ... 6-14.RHEL3.i386.rpm<br />
MySQL 3.23.58 : from CentOS repository<br />
vmail : edited to support vacation messages<br />
SpamAssassin 3.0.4 : from http:&#47;&#47;spamassassin.apache.org, see their notes for RPM compilation<br />
SquirrelMail 1.4.3a-9 : from CentOS repo<br />
Courier-imap 3.0.3-1 (+ MySQL support) : from CentOS Contrib repo (should be enabled under yum)</p>
<p>My IP configuration :</p>
<p>eth0 Link encap:Ethernet HWaddr 00:04:75:XX:XX:XX<br />
inet addr:192.168.250.3 Bcast:192.168.250.255 Mask:255.255.255.0</p>
<p>eth1 Link encap:Ethernet HWaddr 00:04:75:XX:XX:XX<br />
inet addr:192.168.254.3 Bcast:192.168.254.255 Mask:255.255.255.0</p>
<p>eth1:0 Link encap:Ethernet HWaddr 00:04:75:XX:XX:XX<br />
inet addr:192.168.254.4 Bcast:192.168.254.255 Mask:255.255.255.0</p>
<p>eth0 acts as the incoming interface, eth1 et eth1:0 act as outgoing interfaces, respectively with and without auto signature</p>
<p>&#47;etc&#47;postfix&#47;main.cf :</p>
<p>myhostname = mx.domain.be<br />
mydomain = domain.be<br />
myorigin = $mydomain<br />
mydestination = $mydomain, $transport_maps, $myhostname<br />
mynetworks = 127.0.0.0&#47;8, 192.168.250.0&#47;24, 192.168.254.0&#47;24</p>
<p>queue_directory = &#47;var&#47;spool&#47;postfix<br />
command_directory = &#47;usr&#47;sbin<br />
daemon_directory = &#47;usr&#47;libexec&#47;postfix<br />
mailbox_command = &#47;usr&#47;bin&#47;procmail</p>
<p>inet_interfaces = 127.0.0.1, 192.168.250.3, 192.168.254.3, 192.168.254.4</p>
<p>sendmail_path = &#47;usr&#47;sbin&#47;sendmail.postfix<br />
newaliases_path = &#47;usr&#47;bin&#47;newaliases.postfix<br />
mailq_path = &#47;usr&#47;bin&#47;mailq.postfix</p>
<p>## Verify sensitive attachment (rejects .scr, .com, etc.)<br />
mime_header_checks = regexp:&#47;etc&#47;postfix&#47;mime_checks</p>
<p>smtpd_banner = mx.domain.be ESMTP<br />
maximal_queue_lifetime = 2d<br />
delay_warning_time = 2h<br />
message_size_limit = 40971520<br />
mailbox_size_limit = 1048576000<br />
virtual_mailbox_limit = 1048576000</p>
<p>setgid_group = postdrop<br />
mail_owner = postfix<br />
notify_classes = resource,software,policy,delay</p>
<p>smtpd_helo_required = yes<br />
smtpd_client_restrictions =<br />
    permit_mynetworks < -- any internal connection doesn't generate a RBL request<br />
    reject_rbl_client sbl-xbl.spamhaus.org < -- 95 % of spam detected by spamhaus<br />
    reject_rbl_client list.dsbl.org<br />
    reject_rbl_client korea.rominet.net<br />
    reject_rbl_client china.rominet.net<br />
    reject_rbl_client taiwan.rominet.net<br />
    reject_rbl_client hong-kong.rominet.net<br />
    reject_rbl_client relays.ordb.org</p>
<p>## MySQL parameters + vmail + vacation<br />
virtual_mailbox_base = &#47;var&#47;spool&#47;postfix&#47;vmail<br />
virtual_minimum_uid = 1000<br />
virtual_mailbox_maps = mysql:&#47;etc&#47;postfix&#47;vmailsql&#47;vmailbox<br />
virtual_alias_maps = mysql:&#47;etc&#47;postfix&#47;vmailsql&#47;valias<br />
transport_maps = mysql:&#47;etc&#47;postfix&#47;vmailsql&#47;transport<br />
virtual_uid_maps = static:1000<br />
virtual_gid_maps = static:1000<br />
local_recipient_maps = $virtual_mailbox_maps</p>
<p>&#47;etc&#47;postfix&#47;master.cf :</p>
<p># =========================<br />
# service type private unpriv chroot wakeup maxproc command + args<br />
# (yes) (yes) (yes) (never) (100)<br />
# =========================<br />
###### filters<br />
## vacation &#47; autoreply<br />
vacation unix - n n - - pipe<br />
    flags=DRhu user=vacation argv=&#47;var&#47;spool&#47;vacation&#47;vacation.pl<br />
## spamassassin<br />
spamassassin unix - n n - - pipe<br />
    user=nobody argv=&#47;usr&#47;bin&#47;spamc -f -e &#47;usr&#47;sbin&#47;sendmail.postfix -oi -f ${sender} ${recipient}<br />
## disclaimer &#47; autosig<br />
autosignature unix - n n - - pipe<br />
    flags=Rq user=filter argv=&#47;etc&#47;postfix&#47;signature&#47;disclaimer -f ${sender} -- ${recipient}<br />
###### end of filters</p>
<p>###### smtp connectivity<br />
## use the following line for no SA &#47; no sig<br />
#smtp inet n - n - - smtpd</p>
<p>## SA incoming&#47;outgoing + no sig<br />
#smtp inet n - n - - smtpd -o content_filter=spamassassin</p>
<p>## Incoming : spamassassin<br />
# Outgoing on 192.168.254.3 : with auto sig<br />
# Outgoing on 192.168.254.4 : without auto sig<br />
127.0.0.1:smtp inet n - n - - smtpd<br />
192.168.250.3:smtp inet n - n - - smtpd -o content_filter=spamassassin < -- incoming connections, spamassassin filter<br />
192.168.254.3:smtp inet n - n - - smtpd -o content_filter=autosignature: <-- outgoing connections, auto sig<br />
192.168.254.4:smtp inet n - n - - smtpd <-- outgoing connections, IP to use to avoid auto sig</p>
<p>Next, files that will make communicate MySQL and Postfix</p>
<p>&#47;etc&#47;postfix&#47;vmailsql&#47;transport :<br />
user = username<br />
password = password<br />
dbname = vmail<br />
table = domains<br />
select_field = transport<br />
where_field = domain<br />
hosts = localhost</p>
<p>&#47;etc&#47;postfix&#47;vmailsql&#47;valias :<br />
user = username<br />
password = password<br />
dbname = vmail<br />
table = valias<br />
select_field = alias<br />
where_field = id<br />
hosts = localhost</p>
<p>&#47;etc&#47;postfix&#47;vmailsql&#47;vgid :<br />
user = username<br />
password = password<br />
dbname = vmail<br />
table = passwd<br />
select_field = gid<br />
where_field = id<br />
hosts = localhost</p>
<p>&#47;etc&#47;postfix&#47;vmailsql&#47;vmailbox :<br />
user = username<br />
password = password<br />
dbname = vmail<br />
table = passwd<br />
select_field = maildir<br />
where_field = id<br />
hosts = localhost</p>
<p>&#47;etc&#47;postfix&#47;vmailsql&#47;vuid :<br />
user = username<br />
password = password<br />
dbname = vmail<br />
table = passwd<br />
select_field = uid<br />
where_field = id<br />
hosts = localhost</p>
<p>MySQL vmail database :</p>
<p>CREATE TABLE `admin` (<br />
`id` varchar(16) NOT NULL default '',<br />
`pw` varchar(64) NOT NULL default '',<br />
PRIMARY KEY  (`id`),<br />
UNIQUE KEY `id` (`id`)<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `deleted` (<br />
`id` varchar(255) default NULL<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `domains` (<br />
`domain` varchar(128) NOT NULL default '',<br />
`pw` varchar(64) NOT NULL default '',<br />
`transport` varchar(10) default 'virtual',<br />
`ulimit` int(6) default '0',<br />
`defquota` varchar(32) default NULL,<br />
`aka` text,<br />
PRIMARY KEY  (`domain`),<br />
UNIQUE KEY `domain` (`domain`),<br />
KEY `domain_2` (`domain`)<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `new` (<br />
`id` varchar(255) default NULL<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `passwd` (<br />
`id` varchar(255) NOT NULL default '',<br />
`crypt` varchar(64) NOT NULL default '',<br />
`uid` int(4) NOT NULL default '0',<br />
`gid` int(4) NOT NULL default '0',<br />
`home` varchar(255) NOT NULL default '',<br />
`maildir` varchar(255) NOT NULL default '',<br />
`gecos` varchar(128) default NULL,<br />
`en` int(1) NOT NULL default '1',<br />
`quota` varchar(32) default NULL,<br />
PRIMARY KEY  (`id`),<br />
UNIQUE KEY `id` (`id`),<br />
KEY `id_2` (`id`)<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `renamed` (<br />
`id` varchar(255) default NULL,<br />
`newid` varchar(255) default NULL<br />
) TYPE=MyISAM;</p>
<p>CREATE TABLE `vacation` (<br />
`email` varchar(255) NOT NULL default '',<br />
`subject` varchar(255) NOT NULL default '',<br />
`body` text NOT NULL,<br />
`cache` text NOT NULL,<br />
`domain` varchar(255) NOT NULL default '',<br />
`created` datetime NOT NULL default '0000-00-00 00:00:00',<br />
`active` tinyint(1) NOT NULL default '1',<br />
PRIMARY KEY  (`email`),<br />
KEY `email` (`email`)<br />
) TYPE=MyISAM COMMENT='Postfix Admin - Virtual Vacation';</p>
<p>CREATE TABLE `valias` (<br />
`id` varchar(255) NOT NULL default '',<br />
`alias` varchar(255) NOT NULL default '',<br />
PRIMARY KEY  (`id`),<br />
UNIQUE KEY `id` (`id`),<br />
KEY `id_2` (`id`)<br />
) TYPE=MyISAM;</p>
<p>Add this to root&rsquo;s crontab :<br />
*&#47;5 * * * * &#47;directory&#47;to&#47;vmail&#47;scripts&#47;.&#47;maintain<br />
*&#47;5 * * * * &#47;bin&#47;chown vmail:vmail -R &#47;var&#47;spool&#47;postfix&#47;vmail&#47;* (directory specified in virtual_mailbox_base)<br />
*&#47;5 * * * * &#47;bin&#47;chmod 755 -R &#47;var&#47;spool&#47;postfix&#47;vmail&#47;* (dito)</p>
<p>These crons will run the maintenance scripts needed by vmail to keep track of adding&#47;deletions&#47;modifications made to users, domains, etc.<br />
It simply means you need to wait for cron to run to see a new user appears, or you can always run the script by hand (that&rsquo;s what I usually do, I don&rsquo;t enable the cron).</p>
<p>Vmail scripts :<br />
Wed Jun 22 14:42:01 => &#47;directory&#47;to&#47;vmail&#47;scripts<br />
root(1034)# l<br />
total 24K<br />
-rwxr-xr-x 1 root root 4.8K Mar 12 22:28 maintain<br />
-rwxr-xr-x 1 root root 635 Jan 25 2003 pfsqlfiles<br />
-rwxr-xr-x 1 root root 6.0K Mar 12 22:29 vmadmin<br />
-rwxr-xr-x 1 root root 1.0K Jan 25 2003 vmail.sql</p>
<p>You need to edit these files to match your config</p>
<p>Ex : &#47;directory&#47;to&#47;vmail&#47;scripts&#47;maintain :<br />
#########################<br />
$basedir = '&#47;var&#47;spool&#47;postfix&#47;vmail';<br />
$dbhost = 'localhost';<br />
$db = 'vmail';<br />
$dbuser = 'username';<br />
$dbpw = 'password';<br />
$maildirmake = '&#47;usr&#47;lib&#47;courier-imap&#47;bin&#47;maildirmake'; < -- depends on your config<br />
#########################</p>
<p>courier-imap configuration :</p>
<p>We need to enable POP3 and IMAPD service and MySQL for courier-imap to be able to fetch users information :</p>
<p>Edit imapd and pop3d files and make sure POP3DSTART=YES and IMAPDSTART=YES are set. You can disable POP3D-SSL and IMAPD-SSL if you don&rsquo;t need them.</p>
<p>Edit authdaemonrc (should be under &#47;usr&#47;lib&#47;courier-imap&#47;etc) et modify these 2 values :<br />
authmodulelist="authmysql authpam"<br />
authmodulelistorig="authmysql authpam"</p>
<p>Make sure ports tcp&#47;110 and tcp&#47;143 are not blocked by your firewall.</p>
<p>Vacation message :</p>
<p>For auto-replies, I use a script I grabbed from the tool &ldquo;Postfix Admin&rdquo; (available at http:&#47;&#47;high5.net&#47;postfixadmin&#47;). Download the latest version and get vacation.pl.</p>
<p>Edit vacation.pl : to match your configuration&hellip;</p>
<p>my $db_type = 'mysql';<br />
my $db_host = 'localhost';<br />
my $db_user = '<db_user>';<br />
my $db_pass = '<db_pass>';<br />
my $db_name = 'vmail';<br />
my $sendmail = "&#47;usr&#47;sbin&#47;sendmail";<br />
my $logfile = ""; # specify a file name here for example: vacation.log<br />
my $debugfile = ""; # sepcify a file name here for example: vacation.debug<br />
my $syslog = 0; # 1 if log entries should be sent to syslog<&#47;db_pass><&#47;db_user></p>
<p>The filter named &ldquo;vacation&rdquo; under master.cf will call this script as soon as a mail is sent to user@autoreply.domain.be.</p>
<p>Enabling autoreply on a mailbox :<br />
Okay, let&rsquo;s say we&rsquo;ve got this setup for this user and we want to enable an autoreply<br />
Email (alias) : jean.dupont@domain.be<br />
POP account : jdupont@domain.be<br />
Autoreply address jdupont@autoreply.domain.be</p>
<p>You&rsquo;ll need to setup postfix to make it send a copy on jdupont@domain.be and jdupont@autoreply.domain.be (fictive domainname) of any mail sent to jean.dupont@domain.be</p>
<p>Follow me ? Right.. let&rsquo;s recap :<br />
Email sent to jean.dupont@domain.be<br />
&ndash;> postfix receives the message<br />
&mdash;> postfix delivers the message to jdupont@domain.be<br />
&mdash;> postfix virtually &ldquo;delivers&rdquo; the message to jdupont@autoreply.domain.be</p>
<p>Upon reception of a message on autoreply.domain.be, postfix will call the vacation script that will send a message back to the sender of the mail. The script is developped to keep track of senders, it avoids an autoreply to be generated at every incoming mail from a particular contact.</p>
<p>Adding an automatic signature or disclaimer to outgoing mails</p>
<p>In order to add an autosig or disclaimer (like banks do) at the end of outgoing email, you just need to use Altermime available at http:&#47;&#47;www.pldaniels.com&#47;altermime&#47;.</p>
<p>Once compiled and installed, postfix will call the filter called &ldquo;autosignature&rdquo; (see master.cf) which will execute a perl script that will check if the outgoing mail is either HTML or TXT. Indeed, there are two different type of disclaimer, an HTML and TXT version.</p>
<p>Filtering sensitive attachments</p>
<p>&#47;etc&#47;postfix&#47;mime_checks :<br />
&#47;^s*Content-(Disposition|Type).*names*=s*"?(.+.(com|zip|exe|scr|pif))"?s*$&#47; REJECT *** FOR SECURITY REASONS, ".$3" FILETYPES ARE AUTOMATICALLY REJECTED BY THIS SERVER, "$2" WAS REJECTED AS IT MAY CONTAIN VIRUSES ***</p>
<p>Please be aware this method won&rsquo;t let any mail with the specified files attached get into your system. The mail will be rejected and a notification will be sent to the sender with the REJECT message.</p>
<p>Now run :<br />
postalias mime_checks<br />
It&rsquo;ll generate mime_checks.db</p>
<p>Webmail : SquirrelMail</p>
<p>Easy, you just need to install the package squirrelmail from CentOS repositories</p>
<p>After installation, reboot your webserver to apply squirrelmail configuration (actually it&rsquo;s just an alias added in your webserver config, the URL would be http:&#47;&#47;www.domain.be&#47;webmail&#47;)</p>
<p>Run &#47;usr&#47;share&#47;squirrelmail&#47;config&#47;.&#47;conf.pl and edit to match your config</p>
<p>You can add or remove plugins</p>
<p>I use and strongly recommend the SSL plugin that allows secure connections to squirrelmail.<br />
Check this website http:&#47;&#47;slacksite.com&#47;apache&#47;certificate.html to figure out how to add a SSL key to your website</p>
<p>Queue management under Postfix</p>
<p>I use pfqueue that easily manage postfix queues</p>
<p>Available at http:&#47;&#47;pfqueue.sourceforge.net&#47;</p>
<p>Queues graphs</p>
<p>In order to easily check out my queues status, I use queuegraph</p>
<p>queuegraph : http:&#47;&#47;www.stahl.bau.tu-bs.de&#47;~hildeb&#47;postfix&#47;queuegraph&#47;<br />
mailgraph : http:&#47;&#47;people.ee.ethz.ch&#47;~dws&#47;software&#47;mailgraph&#47;</p>
<p>RBL</p>
<p>I use this script to generate a daily RBL use reports. This script is not available online, contact me if you want a copy.</p>
<p>This is the output of the script :</p>
<p>:: RBL STATS for Dec 13 ::<br />
------------------------------------<br />
LIST COUNT<br />
------------------------------------<br />
sbl-xbl.spamhaus.org ...: 199<br />
list.dsbl.org ..........: 2<br />
spamcop.net ............: 4<br />
====================================<br />
TOTAL: 205</p>
