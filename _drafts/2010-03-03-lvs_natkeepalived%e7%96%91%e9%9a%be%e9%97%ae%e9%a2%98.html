---
layout: post
status: publish
published: true
title: LVS_NAT+keepalived疑难问题
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
wordpress_id: 893
wordpress_url: http://ninjacn.com/?p=893
date: '2010-03-03 15:59:43 +0800'
date_gmt: '2010-03-03 07:59:43 +0800'
categories:
- System
tags:
- lvs
- keepalived
- lvs_nat
comments:
- id: 1044
  author: "感谢"
  author_email: asd@asdf.com
  author_url: ''
  date: '2012-04-08 23:59:00 +0800'
  date_gmt: '2012-04-08 15:59:00 +0800'
  content: ":smile:  \r\n非常感谢。今天也是因为TCP_CHECK后面没有空格，浪费了两个小时，唉。"
---
<p>这个问题很简单，但花了我两天时间，郁闷<br />
正文：</p>
<p>LVS_NAT配置可以参考这篇文件：<a href="http:&#47;&#47;ninjacn.com&#47;?p=884">http:&#47;&#47;ninjacn.com&#47;?p=884<&#47;a><br />
我LVS_NAT环境都搭建好了，测试也正常了，我就不贴具体配置了。现在主要是我想用KEEPALIVED来检测realserver是否正常。<br />
lvs手动启动脚本：<br />
[cc lang="bash"]#!&#47;bin&#47;bash<br />
echo 1 > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_forward<br />
LVSADM='&#47;sbin&#47;ipvsadm'<br />
$LVSADM -C<br />
$LVSADM -A -t 192.168.1.9:80 -s rr<br />
$LVSADM -a -t 192.168.1.9:80 -r 10.10.10.10:80 -m -w 1<br />
$LVSADM -a -t 192.168.1.9:80 -r 10.10.10.11:80 -m -w 1[&#47;cc]<br />
keepalived安装过程：<br />
[cc lang="bash"]<br />
[root@lb keepalived-1.1.19]# .&#47;configure --prefix=&#47; --mandir=&#47;usr&#47;share&#47;man<br />
Keepalived configuration<br />
------------------------<br />
Keepalived version : 1.1.19<br />
Compiler : gcc<br />
Compiler flags : -g -O2<br />
Extra Lib : -lpopt -lssl -lcrypto<br />
Use IPVS Framework : Yes<br />
IPVS sync daemon support : Yes<br />
Use VRRP Framework : Yes<br />
Use Debug flags : No<br />
[root@lb keepalived-1.1.19]# make &amp;&amp; make install[&#47;cc]<br />
keepalived配置如下：<br />
[cc lang="bash"]</p>
<p>global_defs {<br />
notification_email {<br />
acassen@firewall.loc<br />
}<br />
notification_email_from Alexandre.Cassen@firewall.loc<br />
smtp_server 192.168.200.1<br />
smtp_connect_timeout 30<br />
router_id LVS_DEVEL<br />
}<br />
virtual_server 192.168.1.9 80 {<br />
delay_loop 6<br />
lb_algo rr<br />
lb_kind NAT<br />
nat_mask 255.255.255.0<br />
persistence_timeout 20<br />
protocol TCP<br />
real_server 10.10.10.10 80 {<br />
weight 1<br />
HTTP_GET{<br />
url{<br />
path &#47;index.html<br />
digest 9e60b98421b874661bdc7260aa1d6206<br />
}<br />
connect_port 80<br />
connect_timeout 3<br />
}<br />
}</p>
<p>real_server 10.10.10.11 80 {<br />
weight 1<br />
HTTP_GET{<br />
url{<br />
path &#47;index.html<br />
digest 9e60b98421b874661bdc7260aa1d6206<br />
}<br />
connect_port 80<br />
connect_timeout 3<br />
}<br />
}</p>
<p>}[&#47;cc]<br />
重启keepalived后<br />
[cc lang="bash"]&#47;etc&#47;init.d&#47;keepalived start</p>
<p>[root@lb keepalived]# ipvsadm -l<br />
IP Virtual Server version 1.2.1 (size=4096)<br />
Prot LocalAddress:Port Scheduler Flags<br />
-> RemoteAddress:Port Forward Weight ActiveConn InActConn<br />
TCP 192.168.1.9:http rr persistent 20<br />
-> 10.10.10.10:http Masq 1 0 0 [&#47;cc]</p>
<p>它只能检测到第一台realserver，且即使这台realserver 80端口关闭，keepalived也检测不出来，我用TCP_CHECK也试过，都是老样子，请各位高手指教。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;">故障解决：原因是因为keepalived的配置有问题，TCP_CHECK和后面的{符号中间的空格。很惭愧，被个空格折腾了两天。<&#47;span></p>
<p>再贴下日志文件：<br />
[root@lb keepalived]# tail &#47;var&#47;log&#47;messages -f<br />
Mar 3 15:43:37 lb Keepalived_vrrp: Configuration is using : 32921 Bytes<br />
Mar 3 15:43:37 lb Keepalived_vrrp: Using LinkWatch kernel netlink reflector...<br />
<span style="color: #ff0000;">Mar 3 15:44:38 lb Keepalived_healthcheckers: Error connecting server [10.10.10.11:80].<br />
Mar 3 15:44:38 lb Keepalived_healthcheckers: Removing service [10.10.10.11:80] from VS [192.168.1.9:80]<&#47;span><br />
Mar 3 15:44:38 lb Keepalived_healthcheckers: Remote SMTP server [192.168.200.1:25] connected.<br />
Mar 3 15:45:02 lb Keepalived_healthcheckers: MD5 digest success to [10.10.10.11:80] url(1).<br />
Mar 3 15:45:08 lb Keepalived_healthcheckers: Timeout reading data to remote SMTP server [192.168.200.1:25].<br />
<span style="color: #ff0000;">Mar 3 15:45:08 lb Keepalived_healthcheckers: Remote Web server [10.10.10.11:80] succeed on service.<br />
Mar 3 15:45:08 lb Keepalived_healthcheckers: Adding service [10.10.10.11:80] to VS [192.168.1.9:80]<&#47;span><br />
Mar 3 15:45:08 lb Keepalived_healthcheckers: Remote SMTP server [192.168.200.1:25] connected.<br />
^[[AMar 3 15:45:38 lb Keepalived_healthcheckers: Timeout reading data to remote SMTP server [192.168.200.1:25].<br />
Mar 3 15:49:45 lb Keepalived_healthcheckers: Error connecting server [10.10.10.11:80].<br />
Mar 3 15:49:45 lb Keepalived_healthcheckers: Removing service [10.10.10.11:80] from VS [192.168.1.9:80]<br />
Mar 3 15:49:45 lb Keepalived_healthcheckers: Remote SMTP server [192.168.200.1:25] connected.<br />
Mar 3 15:49:57 lb Keepalived_healthcheckers: MD5 digest success to [10.10.10.11:80] url(1).<br />
Mar 3 15:50:03 lb Keepalived_healthcheckers: Remote Web server [10.10.10.11:80] succeed on service.<br />
Mar 3 15:50:03 lb Keepalived_healthcheckers: Adding service [10.10.10.11:80] to VS [192.168.1.9:80]<br />
Mar 3 15:50:03 lb Keepalived_healthcheckers: Remote SMTP server [192.168.200.1:25] connected.<br />
Mar 3 15:50:15 lb Keepalived_healthcheckers: Timeout reading data to remote SMTP server [192.168.200.1:25].</p>
<p>以上日志红色显示区域为realserver10.10.10.11 apache服务重启时生成的</p>
