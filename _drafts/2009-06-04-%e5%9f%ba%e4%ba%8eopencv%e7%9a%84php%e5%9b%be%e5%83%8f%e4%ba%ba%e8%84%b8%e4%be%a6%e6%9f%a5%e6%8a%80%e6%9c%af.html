---
layout: post
status: publish
published: true
title: "基于OpenCV的PHP图像人脸检测识别技术"
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: "本文所介绍的技术不是原创，而是从一个叫Robert Eisele的德国人那里学习来的。他写了一个PHP扩展openCV，只封装了两个函数，叫face_detect和face_count。openCV是一个开源的用C&#47;C++开发的计算机图形图像库，非常强大，研究资料很齐全。本文重点是介绍如何使用php来调用其中的局部的功能。人脸侦查技术只是openCV一个应用分支。"
wordpress_id: 619
wordpress_url: http://ninjacn.com/?p=619
date: '2009-06-04 15:10:40 +0800'
date_gmt: '2009-06-04 07:10:40 +0800'
categories:
- Program
tags:
- opencv
- "人脸检测"
- Program
comments: []
---
<p>本文所介绍的技术不是原创，而是从一个叫Robert Eisele的德国人那里学习来的。他写了一个PHP扩展openCV，只封装了两个函数，叫face_detect和face_count。openCV是一个开源的用C&#47;C++开发的计算机图形图像库，非常强大，研究资料很齐全。本文重点是介绍如何使用php来调用其中的局部的功能。人脸侦查技术只是openCV一个应用分支。<a id="more"></a><a id="more-619"></a></p>
<p>1.安装<br />
从源代码编译成一个动态的so文件。</p>
<p>1.1.安装 OpenCV (OpenCV 1.0.0)<br />
下载地址:http:&#47;&#47;sourceforge.net&#47;project&#47;showfiles.php?group_id=22870&amp;package_id=16948</p>
<div class="code">
#tar xvzf OpenCV-1.0.0.tar.gz<br />
#cd opencv-1.0.0<br />
#.&#47;configure<br />
#make<br />
#make install<br />
#make check (检查是否安装全部正确)<&#47;div><br />
提示： 不要指定安装路径，否则后面编译facedetect会找不到OpenCV的路径。</p>
<p>1.2 安装facedetect<br />
下载地址http:&#47;&#47;www.xarg.org&#47;download&#47;facedetect-1.0.0.tar.gz</p>
<div class="code">
#tar xzvf facedetect-1.0.0.tar.gz<br />
#cd facedetect-1.0.0<br />
#phpize &amp;&amp; .&#47;configure &amp;&amp; make &amp;&amp; make install<&#47;div><br />
编译完之后会提示facedetect.so 文件所在的位置。</p>
<p>最后确认在php.ini加入<br />
extension=facedetect.so，重启apache.</p>
<p>2.函数使用<br />
在phpinfo()里检查是否有facedetect这个模块。<br />
从openCV源代码&#47;data&#47;haarcascades&#47;里头取出所有xml文件放在php的执行目录下</p>
<div class="code">
&#47;&#47;检查有多少个脸型<br />
var_dump(face_count('party.jpeg', haarcascade_frontalface_alt.xml'));</p>
<p>&#47;&#47;返回脸型在图片中的位置参数，多个则返回数组<br />
$arr = face_detect('party.jpeg', haarcascade_frontalface_alt2.xml');<br />
print_r($arr);<&#47;div><br />
3.应用<br />
结合imagick可以将图片做一下应用。因为 face_detect只返回一个矩形参数，包含x，y坐标和w，h长宽参数。下面是我的一个应用demo</p>
<div class="code">
<?php<br />
if($_FILES){</p>
<p>$img = $_FILES['pic']['tmp_name'];<br />
$arr = face_detect($img, 'haarcascade_frontalface_alt2.xml');</p>
<p>&#47;&#47;$arr1 = face_detect($img, 'haarcascade_frontalface_alt_tree.xml');</p>
<p>if(is_array($arr1)) $all =array_merge($arr,$arr1);<br />
else $all = $arr;</p>
<p>$im = new Imagick($img);<br />
&#47;&#47;$draw =new ImagickDraw();<br />
&#47;&#47;$borderColor = new ImagickPixel('red');<br />
&#47;&#47;$draw->setFillAlpha(0.0);<br />
&#47;&#47;$draw->setStrokeColor&nbsp;&nbsp;($borderColor);<br />
&#47;&#47;$draw->setStrokeWidth&nbsp;&nbsp;(1);<br />
if(is_array($all)){<br />
&nbsp;&nbsp;foreach ($all as $v){<br />
&nbsp;&nbsp;&nbsp;&nbsp;$im_cl = $im->clone();<br />
&nbsp;&nbsp;&nbsp;&nbsp;$im_cl->cropImage($v['w'],$v['h'],$v['x'],$v['y']);<br />
&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;$im_cl->swirlImage(60);<br />
&nbsp;&nbsp;&nbsp;&nbsp;$im->compositeImage( $im_cl, Imagick::COMPOSITE_OVER , $v['x'], $v['y'] );</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;&#47;&#47;$draw->rectangle($v['x'],$v['y'],$v['x']+$v['w'],$v['y']+$v['h']);<br />
&nbsp;&nbsp;&nbsp;&nbsp;&#47;&#47;$im->drawimage($draw);<br />
&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;&nbsp;&nbsp;<br />
&nbsp;&nbsp;}<br />
}</p>
<p>&nbsp;&nbsp;header( "Content-Type: image&#47;png" );<br />
&nbsp;&nbsp;echo $im;<br />
}else{<br />
&nbsp;&nbsp;?><br />
&nbsp;&nbsp;<meta http-equiv="Content-Type" content="text&#47;html; charset=utf-8" &#47;><br />
&nbsp;&nbsp;<br />
<form method="POST" enctype="multipart&#47;form-data">
&nbsp;&nbsp;人脸识别试验：只支持jpg,png<br><br />
&nbsp;&nbsp;上传一张图片 <input type="file" name="pic"><br />
&nbsp;&nbsp;<input type="submit" value="upload"><br />
&nbsp;&nbsp;<&#47;form><br />
&nbsp;&nbsp;<?<br />
}<br />
?><&#47;div><br />
有兴趣的朋友可以试试，像<a href="http:&#47;&#47;www.conew.com">www.conew.com<&#47;a>等类似网站应该都使用该技术。</p>
<p>参考资料:<br />
http:&#47;&#47;www.xarg.org&#47;2008&#47;07&#47;face-detection-with-php&#47;<br />
http:&#47;&#47;www.opencv.org.cn&#47;index.php&#47;首页<br />
<a href="http:&#47;&#47;www.cs.iit.edu&#47;~agam&#47;cs512&#47;lect-notes&#47;opencv-intro&#47;index.html">http:&#47;&#47;www.cs.iit.edu&#47;~agam&#47;cs512&#47;lect-notes&#47;opencv-intro&#47;index.html<&#47;a></p>
