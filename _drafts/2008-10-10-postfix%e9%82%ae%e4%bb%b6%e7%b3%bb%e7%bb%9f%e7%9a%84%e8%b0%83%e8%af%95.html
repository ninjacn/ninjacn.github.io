---
layout: post
status: publish
published: true
title: postfix邮件系统的调试
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
excerpt: |-
  一般postfix系统基本都是postfix+mysql+sasl+courier-imap+maildrop组成的，
  其他基本上是加上webmail,mysql的web管理，防垃圾spamassassin,防病毒clamav+amasivd-new等
  具体设置可以参照wxy的文章，非常感谢wxy的共享精神。
  看到很多fans在配置的时候出现很多问题，却不知道如何调试，攥写本文的目的是为了如何调试postfix系统，作为wxy文章的补充。

  先说几个基本的概念：
  1、postfix的smtp认证是通过sasl library读取mysql进行认证的，注意是sasl library不是saslauthd,所以通过testsaslauthd并不能正确地

  调试。
wordpress_id: 13
wordpress_url: http://ninjacn.com/?p=13
date: '2008-10-10 13:42:28 +0800'
date_gmt: '2008-10-10 05:42:28 +0800'
categories:
- Server
tags:
- Server
- "调试"
- "邮件"
comments: []
---
<p>一般postfix系统基本都是postfix+mysql+sasl+courier-imap+maildrop组成的，<br />
其他基本上是加上webmail,mysql的web管理，防垃圾spamassassin,防病毒clamav+amasivd-new等<br />
具体设置可以参照wxy的文章，非常感谢wxy的共享精神。<br />
看到很多fans在配置的时候出现很多问题，却不知道如何调试，攥写本文的目的是为了如何调试postfix系统，作为wxy文章的补充。</p>
<p>先说几个基本的概念：<br />
1、postfix的smtp认证是通过sasl library读取mysql进行认证的，注意是sasl library不是saslauthd,所以通过testsaslauthd并不能正确地</p>
<p>调试。<a id="more"></a><a id="more-13"></a><br />
2、courier-imap,courier-maildrop是通过courier-authlib来读取mysql的信息，所以pop3服务，imap服务，maildrop的投递都是通过</p>
<p>courier-authlib.<br />
3、新版本的sasl2在认证的时候会把用户名<a href="mailto:abc@test.com">abc@test.com<&#47;a>，@后面的当成realm来处理，所以新版本的sasl2通过pam_mysql认证的话将不能支持</p>
<p>多域，所以基本都用sasl2的mysql扩展。具体的例子就是wxy的文章postfix_I是通过pam_mysql的，postfix_II是用的sasl2的mysql扩展。</p>
<p>调试postfix系统的时候最好分模块调试，sasl2 library和mysql进行调试，courier-authlib和mysql进行调试，这样就可以把故障点缩小。</p>
<p>1、courier-aulib和mysql的调试很简单，courier-authlib提供了测试程序authtest<br />
# authtest<br />
Usage: authtest [-s service] userid [ password [ newpassword ] ]</p>
<p># authtest -s smtp <a href="mailto:xxx@test.com">xxx@test.com<&#47;a> 123456<br />
Authentication succeeded.</p>
<p>Authenticated: <a href="mailto:xxx@test.com">xxx@test.com<&#47;a> (uid 1001, gid 1001)<br />
Home Directory: &#47;var&#47;mail&#47;<br />
Maildir: test.com&#47;xxx&#47;Maildir&#47;<br />
Quota: (none)<br />
Encrypted Password: (none)<br />
Cleartext Password: 123456<br />
Options: (none)</p>
<p>出现类似这样的提示表示courier-authlib已经成功了，如不成功，仔细检查authmysqlrc,authdaemonrc文件和mysql的socket，包括文件的权</p>
<p>限。特别要注意authmysqlrc,authdaemonrc里不能有空格，只能是tab。</p>
<p>2、sasl2 library的调试<br />
sasl2提供了2个测试程序sasl2-sample-server、sasl2-sample-client,一个服务程序，一个客户程序，如果是rpm安装的,在cyrus-sasl-</p>
<p>devel包中，如果是编译安装的，在sample目录里。postfix smtp认证是也是通过类似的办法，现启动一个sasl_server,然后在启动一个</p>
<p>sasl_client连接sasl_server进行认证。<br />
测试程序sasl2-sample-server、sasl2-sample-client调用的是&#47;usr&#47;lib&#47;sasl2&#47;sample.conf,postfix调用的是smtpd.conf<br />
调试的时候拷贝smtpd.conf成sample.conf<br />
然后运行服务程序sasl2-sample-server<br />
# sasl2-sample-server -s smtpd<br />
trying 10, 1, 6<br />
trying 2, 1, 6<br />
bind: Address already in use<br />
运行客户程序sasl2-sample-client<br />
# sasl2-sample-client -s smtpd -m LOGIN localhost<br />
receiving capability list&hellip; recv: {11}<br />
PLAIN LOGIN<br />
PLAIN LOGIN<br />
send: {5}<br />
LOGIN<br />
send: {1}<br />
N<br />
recv: {9}<br />
Username:<br />
please enter an authentication id: <a href="mailto:abc@test.com">abc@test.com<&#47;a><br />
Password:<br />
send: {16}<br />
<a href="mailto:abc@test.com">abc@test.com<&#47;a><br />
recv: {9}<br />
Password:<br />
send: {6}<br />
123456<br />
successful authentication<br />
closing connection</p>
<p>服务端程序应为<br />
accepted new connection<br />
send: {11}<br />
PLAIN LOGIN<br />
recv: {5}<br />
LOGIN<br />
recv: {1}<br />
N<br />
send: {9}<br />
Username:<br />
recv: {16}<br />
<a href="mailto:abc@test.com">abc@test.com<&#47;a><br />
send: {9}<br />
Password:<br />
recv: {6}<br />
123456<br />
successful authentication <a href="mailto:&lsquo;abc@test.com&rsquo;">&lsquo;abc@test.com&rsquo;<&#47;a><br />
closing connection</p>
<p>成功之后把sample.conf 拷贝为smtpd.conf，不成功就检查sasl2的配置。</p>
<p>postfix和sasl2的调试<br />
网上还有个脚本叫saslfinger,可以下载下来查查，当然配置不一样出来的结果也不一样，可以作为参考。postfix的设置比较多，一定要心细</p>
<p>。</p>
<p>如果courier-authlib通过了的话，courier-imap基本不会出现问题，调试可以用telnet 110端口，如果出现问题的原因大部分在maildir目录</p>
<p>，检查目录存在，目录权限等。</p>
<p>linux系统大部分的出错提示都可以在log中看到，仔细分析一下log找出错误的原因。</p>
