---
layout: post
status: publish
published: true
title: "红帽Piranha构建高可用性WEB服务【NAT】测试"
author:
  display_name: Ninjacn
  login: admin
  email: x@ninjacn.com
  url: ''
author_login: admin
author_email: x@ninjacn.com
wordpress_id: 929
wordpress_url: http://ninjacn.com/?p=929
date: '2011-02-14 00:08:34 +0800'
date_gmt: '2011-02-13 16:08:34 +0800'
categories:
- System
tags:
- centos
- lvs
- nat
- Piranha
- redhat
- pir
comments:
- id: 5855
  author: Ninjacn
  author_email: x@ninjacn.com
  author_url: ''
  date: '2016-01-07 00:34:10 +0800'
  date_gmt: '2016-01-06 16:34:10 +0800'
  content: "<img class='wpml_ico' alt='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_cool.gif'
    src='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_cool.gif'
    &#47;><img class='wpml_ico' alt='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_mail.gif'
    src='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_mail.gif'
    &#47;><img class='wpml_ico' alt='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_mail.gif'
    src='http:&#47;&#47;ninjacn.com&#47;wp-content&#47;plugins&#47;wp-monalisa&#47;icons&#47;wpml_mail.gif'
    &#47;>"
- id: 5856
  author: coder
  author_email: ninjacn@163.com
  author_url: ''
  date: '2016-01-07 00:37:24 +0800'
  date_gmt: '2016-01-06 16:37:24 +0800'
  content: "@Ninjacn haha"
---
<p><a href="http:&#47;&#47;ninjacn.com&#47;&#47;wp-content&#47;uploads&#47;2011&#47;02&#47;Piranha-NAT.png"><img class="alignnone size-full wp-image-930" title="Piranha-NAT" src="http:&#47;&#47;ninjacn.com&#47;&#47;wp-content&#47;uploads&#47;2011&#47;02&#47;Piranha-NAT.png" alt="Piranha-NAT" width="798" height="582" &#47;><&#47;a></p>
<p><span style="color: #ff0000;">（此方案如果加了双机功能，有很大缺陷，仅限学习测试）<&#47;span></p>
<p><span style="color: #ff0000;">缺点：双机检测时只检测外网卡，内网卡一旦坏了，双机会不起作用。<&#47;span></p>
<p>环境说明：CENTOS 5.5</p>
<p>注意：各个服务器之间时间必须同步，否则会失败！</p>
<p>4台服务器，两台LVS互做备份，两台WEB节点。</p>
<p>Piranha详细功能不多说，可以参考REDHAT官网资料。</p>
<p>安装：<span style="color: #000000;"><&#47;span></p>
<p>[bash]<br />
#yum install ipvsadm modcluster piranha system-config-cluster php php-cli php-common[&#47;bash]<br />
lvs.conf配置如下：<br />
[bash]<br />
serial_no = 50<br />
primary = 192.168.1.10<br />
service = lvs<br />
backup_active = 1<br />
backup = 192.168.1.11<br />
heartbeat = 1<br />
heartbeat_port = 539<br />
keepalive = 6<br />
deadtime = 18<br />
network = nat<br />
nat_router = 10.0.0.12 eth1:0<br />
nat_nmask = 255.255.255.0<br />
debug_level = NONE<br />
monitor_links = 1<br />
syncdaemon = 1<br />
virtual web_test_nat {<br />
     active = 1<br />
     address = 192.168.1.12 eth0:1<br />
     vip_nmask = 255.255.255.0<br />
     port = 80<br />
     pmask = 255.255.255.255<br />
     send = "GET &#47; HTTP&#47;1.0\r\n\r\n"<br />
     use_regex = 0<br />
     load_monitor = none<br />
     scheduler = rr<br />
     protocol = tcp<br />
     timeout = 3<br />
     reentry = 0<br />
     quiesce_server = 0<br />
     server node01 {<br />
         address = 10.0.0.20<br />
         active = 1<br />
         port = 80<br />
         weight = 1<br />
     }<br />
     server node02 {<br />
         address = 10.0.0.21<br />
         active = 1<br />
         port = 80<br />
         weight = 1<br />
     }<br />
}[&#47;bash]<br />
配置在WEB界面下http:&#47;&#47;192.168.1.10:3636&#47;，配置完成后可关闭prinaha-gui服务。<br />
本机和备机只需要启动pulse服务即可。<br />
[bash]service pulse start[&#47;bash]<br />
备机的配置只需要scp过来即可。<br />
在NAT模式下，要打开转发功能。<br />
[bash]echo "1" > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_forward[&#47;bash]<br />
也可以将些句写时&#47;etc&#47;init.d&#47;pulse里面，如下：<br />
[bash]# See how we were called.<br />
case "$1" in<br />
  start)<br />
        echo -n "Starting pulse: "<br />
	#NAT<br />
	echo "1" > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_forward<br />
        daemon pulse $OPTIONS<br />
	RETVAL=$?<br />
        echo<br />
        [ $RETVAL -eq 0 ] &amp;&amp; touch &#47;var&#47;lock&#47;subsys&#47;pulse<br />
        ;;</p>
<p>  stop)<br />
        echo -n "Shutting down pulse: "<br />
	#NAT<br />
	echo "0" > &#47;proc&#47;sys&#47;net&#47;ipv4&#47;ip_forward<br />
	killproc pulse<br />
	RETVAL=$?<br />
        echo<br />
        [ $RETVAL -eq 0 ] &amp;&amp; rm -f &#47;var&#47;lock&#47;subsys&#47;pulse<br />
        ;;[&#47;bash]</p>
<p>节点配置：<br />
2台节点都开启WEB端口，网卡配置如下：<br />
[bash]DEVICE=eth1<br />
BOOTPROTO=none<br />
ONBOOT=yes<br />
HWADDR=00:0c:29:03:f4:ea<br />
NETMASK=255.255.255.0<br />
IPADDR=10.0.0.20<br />
TYPE=Ethernet<br />
GATEWAY=10.0.0.12[&#47;bash]<br />
注意网关一定要写正确。<br />
查看路由表：<br />
[bash][root@node01 ~]# route<br />
Kernel IP routing table<br />
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br />
10.0.0.0        *               255.255.255.0   U     0      0        0 eth1<br />
169.254.0.0     *               255.255.0.0     U     0      0        0 eth1<br />
default         10.0.0.12       0.0.0.0         UG    0      0        0 eth1<br />
[&#47;bash]</p>
